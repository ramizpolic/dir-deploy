# Copyright AGNTCY Contributors (https://github.com/agntcy)
# SPDX-License-Identifier: Apache-2.0

version: '3'

tasks:
  default:
    cmds:
      - task -l

  gen:
    desc: Generate application manifests
    cmds:
      - task: gen:dir

  gen:dir:
    desc: Generate Directory application manifests
    vars:
      FEDERATION_SOURCE: "{{ .ROOT_DIR }}/onboarding/federation/*.yaml"
      DEST_VALUES_DEV: "{{ .ROOT_DIR }}/applications/dir/dev/gen.values.yaml"
      DEST_VALUES_PROD: "{{ .ROOT_DIR }}/applications/dir/prod/gen.values.yaml"
    cmds:
      # Add initial autogen comment to the destination file
      - echo "# This file is autogenerated by 'task gen:dir'." > {{ .DEST_VALUES_DEV }}
      - echo "# Do not edit directly." >> {{ .DEST_VALUES_DEV }}

      # Merge all federation configs into the destination file.
      # Only use bash and taskfile built-ins for compatibility.
      - |
        # One-liner to convert dot notation to YAML hierarchy
        cat <<EOF >> {{ .DEST_VALUES_DEV }}
        apiserver:
          spire:
            federation:
        EOF
        for file in {{ .FEDERATION_SOURCE }}; do
          if [ -f "$file" ]; then
            echo "    -" >> {{ .DEST_VALUES_DEV }}
            cat "$file" | sed 's/^/      /' >> {{ .DEST_VALUES_DEV }}
          fi
        done
      
      # Repeat for prod values file
      - cp {{ .DEST_VALUES_DEV }} {{ .DEST_VALUES_PROD }}
      
      # Cleanup
      - rm -rf {{ .FEDERATION_DEST }}
