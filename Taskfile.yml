version: '3'

tasks:
  default:
    cmds:
      - task -l

  gen:
    desc: Generate application manifests
    cmds:
      - task: gen:dir

  gen:dir:
    desc: Generate Directory application manifests
    vars:
      DEST_VALUES: "{{ .ROOT_DIR }}/applications/dir/gen.values.yaml"
      FEDERATION_SOURCE: "{{ .ROOT_DIR }}/onboarding/federation/*.yaml"
      FEDERATION_KEY: "apiserver.spire.federation"
    cmds:
      # Add initial autogen comment to the destination file
      - echo "# This file is autogenerated by 'task gen:dir'. Do not edit directly." > {{ .DEST_VALUES }}

      # Merge all federation configs into the destination file
      - |
        echo "{{ .FEDERATION_KEY }}:" >> {{ .DEST_VALUES }}
        for file in {{ .FEDERATION_SOURCE }}; do
          if [ -f "$file" ]; then
            echo "  -" >> {{ .DEST_VALUES }}
            cat "$file" | sed 's/^/    /' >> {{ .DEST_VALUES }}
          fi
        done
